@model IEnumerable<dynamic>

@{
    ViewData["Title"] = "Aprobacion de auditoria mensual - Almacen";
}

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewData["Title"]</title>
    <link rel="stylesheet" href="~/css/supervisor.css">
</head>
<body>
    <header>
        <a href="@Url.Action("Login", "Account")" class="back-button">
            <img src="~/images/previous.png" alt="Regresar" />
        </a>
        <h1>@ViewData["Title"]</h1>
    </header>
    <table class="audit-table">
        <thead>
            <tr>
                <th>Fecha de Auditoría</th>
                <th>Estado de Aprobación Almacen</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var group in Model)
            {
                var isApprovedIncoming = group.Estado == "Aprobado"; // Verificación para Incoming

                // Convertir explícitamente group.Quimicos a un IEnumerable o List
                var quimicosList = (IEnumerable<dynamic>)group.Quimicos;

                // Verificar aprobaciones de Storage
                var isApprovedStorage = quimicosList.All(q =>
                {
                    var aprobacionesList = (IEnumerable<dynamic>)q.Aprobaciones; // Convertir Aprobaciones a IEnumerable
                    return aprobacionesList.Any(a => a.ApprovedByStorage != null);
                });

                <tr>
                    <td>@group.AuditDate.ToString("MM-dd-yyyy")</td>
                    <td>
                        @if (isApprovedStorage)
                        {
                            <span class="approved-storage">Aprobado</span>
                        }
                        else if (isApprovedIncoming)
                        {
                            <span class="pending-storage">Pendiente de Aprobación</span>
                        }
                        else
                        {
                            <span class="not-approved">Aprobacion pendiente por Incoming</span>
                        }
                    </td>
                    <td>
                        <!-- Botón para ver detalles -->
                        <a href="@Url.Action("Details", "Details", new { date = DateTime.Parse(group.AuditDate.ToString()).ToString("yyyy-MM-dd") })" class="details-btn">Ver Detalles</a>

                        <!-- Mostrar "Aprobar" solo si ya ha sido aprobado por Incoming -->
                        @if (isApprovedIncoming && !isApprovedStorage)
                        {
                            <button class="approve-btn" data-date="@group.AuditDate.ToString("yyyy-MM-dd")" data-role="Storage">Aprobar</button>
                        }
                        else if (!isApprovedIncoming)
                        {
                            <button class="approve-btn" disabled>Pendiente</button>
                        }
                        else
                        {
                            <button class="approve-btn" disabled>Aprobado</button>
                        }
                    </td>
                </tr>
            }

        </tbody>
    </table>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="~/js/supervisor.js"></script>
    <script src="~/js/sesionkiller.js"></script>
</body>
</html>
